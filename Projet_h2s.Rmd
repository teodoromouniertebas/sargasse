---
title: "Projet_h2s"
author: "Domitille"
date: "16/07/2021"
output:
  html_document: 
    highlight: textmate
    theme: readable
    toc: yes
    toc_float: yes
---

<style>
body {
text-align: justify}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE,
#fig.width = 7, fig.height = 7,
#out.width = 7, out.height = 7,
#collapse = TRUE,  fig.show = "hold", out.width = "75%", fig.align = "center")
collapse = TRUE,  fig.show = "hold",
out.width = "75%")
```

<br>

```{r echo=FALSE, fig.align='left', out.width='100%'}
knitr::include_graphics(here::here("./images/Sargasse.jpg"))
```


## Sommaire

 * Introduction
 * Visualisation des données
 * Modélisations
 * Soumission des prévisions et conclusion

--------------------

## Introduction

Selon [Franceinfo](https://www.francetvinfo.fr/sante/environnement-et-sante/c-est-quoi-le-probleme-avec-les-sargasses-ces-algues-toxiques-qui-proliferent-dans-les-antilles_2962815.html) les sargasses sont des microalgues brunes équipées de flotteurs naturels qui leur permettent de coloniser la surface de la mer et de s'y multiplier. Elles peuvent ainsi envahir des dizaines de kilomètres de littoral. Ces algues abritent une multitude de poissons et même d'insectes, explique Thomas Changeux, ingénieur à l'IRD affecté à l'Institut méditerranéen d'océanologie (MIO) et interrogé par l'AFP.

Les sargasses étaient d'abord localisées dans le nord de l'Atlantique, mais elles se sont déplacées vers le Sud entre Amérique latine et Afrique. Elles ne sont pas nouvelles dans les Antilles, où elles investissent le littoral depuis 2011. Mais, depuis février, elles arrivent en masse sur les côtes de Guadeloupe, Martinique, Saint-Martin, Saint-Barthélemy.

Plusieurs hypothèses sont sur la table pour expliquer ce phénomène : " les alizés et les courants [qui] font des tapis roulants" aux algues, il y a aussi "les apports de l'Amazonie en nitrates et phosphates " avec la surexploitation agricole, voire le réchauffement de l'eau, selon le chercheur. Au cours d'une visite en Guadeloupe, à l'automne 2018, Emmanuel Macron, lui, avait directement pointé du doigt "les conséquences du réchauffement climatique".

Le but de ce projet est de créer des modèles additifs généralisés qui prédisent au mieux l'arriver des Sargasse sur les côtes de Martinique. Nous construirons pour cela différents GAM sur la base d’entraînement, modèles que nous chercherons à optimiser pour les rendre les plus performants possible, puis nous les appliquerons sur la base ‘test’ où nous espérons les erreurs les plus faibles.

 

<br>

Dans un premier temps nous appelons les **librairies** qu'il nous faut pour réaliser le projet :
 
```{r library}
library(tidyverse)
library(readr)
library(gganimate)
library(viridis)
library(gridExtra)
library(plotly)
library(summarytools)
library(kableExtra)
library(knitr)
library(flextable)
library(tsoutliers)
library(EnvStats)
library(stringr)
library(seastests)
#install.packages("rAmCharts")
library(rAmCharts)
library(mgcv)
library(car)
library(tinytex)
library(xtable)
library(r2d3)
library(DataExplorer)
#package de cartographie
library(sf)
library(cartography)
```

<br>

--------------------

## 1-Analyse exploratoire des données

<br>

### 1.1 Téléchargement des données 


Nous avons téléchargé les données :

```{r echo=TRUE}
df <- readxl::read_xlsx('./Données/h2s.xlsx')
```

Les données brutes contiennent `r length(df)` variables et `r nrow(df)` observations.


### 1.2 Premières informations sur les variables

Nous regardons les 10 premières lignes de notre jeu de données pour nous rendre compte des informations qu'il contient. Nous pouvons aussi regarder le format des variables grâce à la commande **str()**. Puis, le *summary* de la base nous donnera un aperçu des distributions des variables avec les valeurs minimales et maximales de chacune d'elle ainsi que la moyenne, les quartiles etc. Le but de cette analyse exploratoire étant de cerner au mieux les données pour éventuellement créer de nouvelles variables ou transformer les existantes.

```{r echo=TRUE}
kbl(head(df,100), align = "c") %>%  kable_classic_2() %>% kable_styling(font_size = 11, bootstrap_options = c("striped", "hover"),fixed_thead = list(enabled = T, background = "lightgrey"))
```

Comme nous pouvons le voir ci-dessus, nous disposons initialement de 8 variables :

* **date** : variable avec la date et les heures
* **territoire** : 
* **nom** : Variable qui renseigne le nom de la zonne étudier. 
* **commune** : Variable avec les villes de martiniques.
* **polluant** : colonne qui ne contient que **H2S**, donc pas très utile.
* **m_hor** : variable qui renseigne la mesure de l'hydrogène sulfuré.
* **...7** : colonne composé que de NA.
* **moyenne** : variable avec une seul valeur.

<br>

```{r}
str(df)
```
Sur nos `r ncol(df)` variables 4 sont aux format character ; et la variable qui nous intéresse *m_hor* au format numérique avec une moyenne de `r mean(df$m_hor)`.

<br>

Enfin nous pouvons nous assurer de l'absence de données pour les deux dernière colonne avec la fonction **plot_missing** du package **DataExplorer**.

```{r echo=FALSE}
DataExplorer::plot_missing(df, ggtheme = theme_classic())
```
<br>

### 1.3 Nettoyage de la base

* On retire les deux dernière colonnes **moyenne** et **...7**.
* On sépare en deux variables **date** et **heure**, la variable initiale **date**.
* On supprime la colonne **polluant** qui nous apporte pas d'information importante.
* On renomme la variable **m_hor** en **h2s** qui est plus compréhensible et **nom** par **zone**.

Suite à toutes ces modifications la nouvelle base de donnée ressemble à cela :

```{r echo=FALSE}
df <- df %>% select(-c(moyenne,polluant,...7)) %>% separate(date, c("date","heures"), sep = " ") %>% rename(h2s = m_hor, zone = nom)

#On change le format de date:
#df$year <- format(as.Date(df$date, format="%Y-%m-%d"),"%Y")
#df$date <- as.Date(df$date)


#On récupe seulement l'heure et pas les minutes ou secondes car toujours 00, ensuite on convertit la variable heure en format numérique :
df <- df %>% separate(heures, c("heures","minutes","secondes"), sep = ":") %>% select(-c(minutes,secondes))
df$heures <- as.numeric(df$heures)
kbl(head(df,100), align = "c") %>%  kable_classic_2() %>% kable_styling(font_size = 11, bootstrap_options = c("striped", "hover"),fixed_thead = list(enabled = T, background = "lightgrey")) 
```

<br>


## 2-Visulation cartographique des données {.tabset}

### 2.1 Préparation des données {.tabset}



Avant toute transformation des variables nous allons visualiser, étant données que nous somme face à des données territorial, il est interressant de les représenter sur une carte avec le package **sf**. Nous allons tout d'abord importer du package **cartography** la carte de la martinique qui se représente grâce à la colonne *geom*.

```{r echo=FALSE, fig.align='center'}
# On importe la base permettant de faire des cartes:
mtq <- st_read(system.file("gpkg/mtq.gpkg", package="cartography"), quiet = TRUE)

# On va concerver seulement les variables qui nous interesse c'est à dire la carte de la martinique  :
mtq <- mtq %>% select(LIBGEO,geom)

#On visualise :
par(mar=c(0,0,1.2,0))
plot(st_geometry(mtq), col = "#fde49a", border = "grey", 
     bg = "#aad3df")
layoutLayer(
  title = "Martinique", 
  sources = "IGN", 
  author = "Domitille DEBAUCHE, 2021",
  north = TRUE
)
```

Avant de pouvoir représenter les données sur la carte, nous avons du joindre les coordonées géographique au data.frame initial. Le code suivant permet cela.


```{r echo=TRUE}
# On regroupe les deux data.frame :
# Afin de pouvoir joindre les deux Data.frame nous allons renommé les nom de commune à l'identique 
df <- as.data.frame(df)
df <- df %>% mutate(commune = case_when( 
  commune == "Diamant" ~ "Le Diamant",
  commune == "François" ~ "Le François",
  commune == "Vauclin" ~ "Le Vauclin",
  commune == "Robert" ~ "Le Robert",
  commune == "Marigot" ~ "Le Marigot",
  commune == "Trinité" ~ "La Trinité",
  commune == "François" ~ "Le François",
  TRUE ~ as.character(commune)))

#Nous pouvons joindre les deux data.frame et remplacer les NA par des 0:
dfcarto <- left_join(mtq,df, by = c("LIBGEO" = "commune")) %>% 
  rename("commune" = "LIBGEO") %>% 
        mutate(date = replace_na(date,0),
         heures = replace_na(heures,0),
         territoire =replace_na(territoire,0),
         zone = replace_na(zone,0),
         h2s = replace_na(h2s,0))
```

<br>

Le nouveau Data.Frame **dfcarto** ressemble à cela :

```{r}
kbl(head(dfcarto,100), align = "c") %>%  kable_classic_2() %>% kable_styling(font_size = 11, bootstrap_options = c("striped", "hover"),fixed_thead = list(enabled = T, background = "lightgrey"))
```


### 2.2 Zones touchées par les Sargasses {.tabset}


```{r echo=FALSE, fig.align='center'}
# Mesure de la moyenne d'H2S par commune sur toute la période.
p1 <- dfcarto %>% select(commune, h2s, geom) %>% group_by(commune) %>% summarize(moyenneh2s = mean(h2s))


# On visualise les données:
par(mar=c(0,0,1.2,0))
plot(st_geometry(p1$geom), col = "#fde49a", border = "grey", 
     bg = "#aad3df") +
plot(st_geometry(p1[p1$moyenneh2s>0,]), col = "#dc6d24", add=TRUE)

labelLayer(
  x = mtq, 
  txt = "LIBGEO", 
  col= "black", 
  cex = 0.7, 
  font = 4,
  overlap = FALSE, 
  show.lines = FALSE
)

layoutLayer(
  title = "Commune touchées par les Sargasse en Martinique", 
  sources = "IGN", 
  author = "Domitille DEBAUCHE, 2021",
  north = TRUE
)

rm(p1)
```

La graphique précédente nous permet juste de visualiser la répartition des Sargasse en Martinique. On peut observer que nous avons dans notre base de donnée seulement `r n_distinct(df$commune)` communes touché. 


### 2.3 Evolution entre 2020 et 2021 {.tabset}

La graphique suivante montre très clairement que c'est la parti Est de l'île qui est la plus touché en moyenne par ce phénomène sur la période de janvier 2020 à juillet 2021.


```{r echo=FALSE, fig.align='center'}
pp <- dfcarto %>% 
  mutate(year = format(as.Date(dfcarto$date, format="%Y-%m-%d"),"%Y"),year = replace_na(year,0)) %>%
  select(commune, year,h2s, geom) %>% 
  group_by(commune,year) %>%
  summarize(moyenneh2s = mean(h2s))

#Avant les graph, les infos qu'on a besoins :
var <- pp$moyenneh2s
breaks <- getBreaks(v = var, nclass = 5, method = "fisher-jenks")
mypal <- carto.pal(pal1 = "wine.pal", n1 = 5, transparency = T)


p4 <- dfcarto %>% 
  mutate(year = format(as.Date(dfcarto$date, format="%Y-%m-%d"),"%Y"),year = replace_na(year,0)) %>%
  select(commune, year,h2s, geom) %>% 
  group_by(commune,year) %>%
  summarize(moyenneh2s = mean(h2s)) %>% 
  filter(year == "2020" | year == "0")

p5 <- dfcarto %>% 
  mutate(year = format(as.Date(dfcarto$date, format="%Y-%m-%d"),"%Y"),year = replace_na(year,0)) %>%
  select(commune, year,h2s, geom) %>% 
  group_by(commune,year) %>% 
  summarize(moyenneh2s = mean(h2s)) %>% 
  filter(year == "2021" | year == "0")


#Carte Année 2020

p4_bb <- st_bbox(p4)
p5_bb <- st_bbox(p5)

par(mfrow=c(1,2), mar=c(0,.2,1.2,.2))
plot(st_geometry(p4$geom),bg = "#aad3df",col = "#fde49a", 
     xlim = p4_bb[c(1,3)], ylim = p4_bb[c(2,4)])
plot(st_geometry(p4), lwd = 2, add = T)

choroLayer( 
  x = p4, 
  var = "moyenneh2s", 
  breaks = breaks,
  col = mypal,
  add = TRUE,
  legend.pos = NA
  )

legendChoro(pos = "bottomleft",
 title.txt = "Taux h2s",
 breaks = breaks,
 col = mypal,
 nodata = FALSE)
  
labelLayer(
  x = p4, 
  txt = "commune", 
  col= "black", 
  cex = 0.7, 
  font = 4,
  overlap = FALSE, 
  show.lines = FALSE
)

layoutLayer(
  title = "Les Sargasse en Martinique en 2020", 
  sources = "IGN", 
  author = "Domitille DEBAUCHE, 2020",
  north = TRUE
)


# Carte Année 2021

plot(st_geometry(p5$geom),bg = "#aad3df",col = "#fde49a", 
     xlim = p5_bb[c(1,3)], ylim = p5_bb[c(2,4)])
plot(st_geometry(p5), lwd = 2, add = T)

choroLayer( 
  x = p5, 
  var = "moyenneh2s", 
  breaks = breaks,
  col = mypal,
  add = TRUE,
  legend.pos = NA
  )

legendChoro(pos = "bottomleft",
 title.txt = "Taux h2s",
 breaks = breaks,
 col = mypal,
 nodata = FALSE)
  
labelLayer(
  x = p5, 
  txt = "commune", 
  col= "black", 
  cex = 0.7, 
  font = 4,
  overlap = FALSE, 
  show.lines = FALSE
)

layoutLayer(
  title = "Les Sargasse en Martinique en 2021", 
  sources = "IGN", 
  author = "Domitille DEBAUCHE, 2021",
  north = TRUE
)
```




## 3- Etude par zone  {.tabset}

#### Le François {.tabset}

#### Visualisation temporelle  {.tabset}

Dans cette section nous allons essayer de voir si l'on observe des tendance dans la présence du gaz H2S en fonction du temps, et si ce sont les même evolution pour chacune des communes et chacun des lieu.
Nous allons faire l'annalyse pour la commune de *Le François* dans un premier temps. Cette analyse pourra se transposer aux autres régions par la suite.

```{r echo=FALSE}
# On créé une sous-base pour la commune Le François uniquement
df_LeFrancois <- dfcarto %>% filter(commune == "Le François")
df_LeFrancois$date <- as.Date(df_LeFrancois$date)
kbl(head(df_LeFrancois,100), align = "c") %>%  kable_classic_2() %>% kable_styling(font_size = 11, bootstrap_options = c("striped", "hover"),fixed_thead = list(enabled = T, background = "lightgrey"))
```
Cette base recense à chaque heure le taux de h2s dans l'aire pour chacune des zones de récupération de données de la commune Le François sur les 7 derniers mois. Nous allons représenté graphiquement cette évolution par zone et observer les résultats.

<br>
 
```{r echo=FALSE, fig.align='center'}
#Plot1 : 
plot1 <- df_LeFrancois %>% select(date,heures,zone,h2s)
ggplot(plot1) + geom_line(aes(x = date, y = h2s, color = zone),size = 0.5) +
scale_color_brewer(palette="Dark2")+   
labs(title ="Evolution du Taux de h2s dans l'aire pour les zones de Le François sur toute la période", y = "h2s", color = "Zones")+
theme_light()
```

```{r echo=FALSE, fig.align='center'}
#rajout de l'heure en cumulé :
df_LeFrancois$heurescumule <- seq_len(nrow(df_LeFrancois))

#Plot2 : 
plot2 <- df_LeFrancois %>% select(date,zone,h2s,heurescumule) %>% slice(c(0:46556))
p2 <- ggplot(plot2,aes( x = date, y = h2s, color = zone)) + 
geom_line(size = 0.5) +
scale_color_brewer(palette="Dark2")+   
labs(title ="Evolution du Taux de h2s dans l'aire pour les zones de Le François sur toute la période", y = "h2s", color = "Zones")+
theme_light()

ggplotly(p2)
```




